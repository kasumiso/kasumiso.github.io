<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
	</head>
	<body>
		<canvas id="mycvs" width=800 height=600 style="border:solid 1px;"></canvas>
		
		<script>
			var f=[];
				f.stage=0;//ステージ番号　0 or 1
				f.distance=100;//残りの距離
				f.player_hp=3;
			const IMG = 0;
			const X = 1;
			const Y = 2;
			const PARA = 3;
			const ANITYPE = 3;
			const FL = 4;
			const WIDTH = 5;
			const HEIGHT = 6;
			const PWIDTH = 32;
			const PHIGHT = 64;
			const JUMP = 160;
			const BLOCK_MAX = 3;
			const WAITTIME=60;
			var jumped_fl = 0;
			//無敵
			var blink_fl=1;
			var blink_timer=0;
			var blink_cnt=0;
			//アニメーション
			var ani_type=0;
			var isPlaying = true;
			var isGrounded = true;
			var isPaused = false;
			var cvs = document.getElementById("mycvs");
			var ctx = cvs.getContext('2d');
			//プレイヤー
			var player = []; 
				player[IMG] = new Image();
			//敵 1体のみ。一定間隔でランダム出現
			var enemy = [];
				enemy[IMG]= new Image();
			var hitEnemyNum=-1;
			//アイテム
			var item = [];
				item[IMG]= new Image();
			//障害物
			var block = [];
			for(var i=0;i<3;i++){
				block[i] = [];
				block[i][IMG] = new Image();
				block[i][X] = -1;
				block[i][Y] = -1;
				block[i][PARA] = -1;
				block[i][FL] = 0;
			}
			
			var hitBlockNum = -1;
			var block_cnt=0;
			//地面
			var ground = [];
			for(var i=0;i<6;i++){
				ground[i]=[];
				ground[i][IMG] = new Image();
				ground[i][X] = -1;
				ground[i][Y] = -1;
			}
			var jump_y=JUMP;
			var scroll_sp=3;
			var ani_date=[];
			for(var i=0;i<5;i++){//5は仮。アニメーションの種類の数
				ani_date[i]=[];
				ani_date[i][0]=1;//コマ数
				ani_date[i][0]=10;//1コマ辺りのフレーム数
			}
			//ブロックのサイズデータ
			var block_size=[];
			block_size[0]=[32,32];
			block_size[1]=[32,64];
			block_size[2]=[32,64];
			
			Init();
			
			document.onkeydown = function KeyDown(e){
				if(!isPlaying)return;
				if(!isGrounded)return;
				if(e.keyCode == "32"){
					jumped_fl=1;
				}
			}
			
			function Init(){
				//プレイヤー-----------
				player[FL] = 1;
				player[PARA] = 3;
				player[IMG].src="img/player"+f.player_hp+"_run.png";
				player[WIDTH] = PWIDTH;
				player[HEIGHT] = PHIGHT;
				player[X] = 200;
				player[Y] = 504-player[HEIGHT];
				player[ANITYPE] = 0;//走り
				//障害物 初回はとりあえず一個出す-----------
				block[0][PARA]=Math.floor(Math.random()*3);//ブロック3種類
				block[0][IMG].src="img/block0_"+block[0][PARA]+".png";
				block[0][IMG].onload = function () {
					block[0][FL] = 1;
					block[0][WIDTH] = block_size[block[0][PARA]][0];
					block[0][HEIGHT]= block_size[block[0][PARA]][1];
					block[0][X] = 800;
					block[0][Y] = 504-block[0][HEIGHT];
					block_cnt = WAITTIME+Math.floor(Math.random()*180);//次のブロック出現までの時間
					//alert("width="+block[0][WIDTH]+",height="+block[0][HEIGHT]);
				}
				hitBlockNum = -1;
				//敵---------------
				hitEnemyNum = -1;
				//アイテム-----------
				item[FL]=0;
				item[X]=0;
				item[Y]=0;
				item[WIDTH]=28;
				item[HEIGHT]=28;
				//地面-----------
				for(var i=0;i<6;i++){
					ground[i][PARA]=Math.floor(Math.random()*3);
					ground[i][IMG].src="img/stage0_"+ground[i][PARA]+".png";
					ground[i][X] = i*160;
					ground[i][Y] = 504;
				}
				
				UpDate();
			}
			
			function UpDate(){
			
				if(jumped_fl==1){
					player[Y]-=6;
					jump_y-=6;
					if(jump_y<=0){
						jump_y=JUMP;
						jumped_fl=2;
					}
				}else if(jumped_fl==2){
					player[Y]+=6;
					if(player[Y]+player[HEIGHT]>504){
						player[Y]=504-player[HEIGHT];
						jumped_fl=0;
					}
				}
				if(block_cnt>0){
					block_cnt--;
				}else{
					var check=-1;
					for(var i=0;i<block.length;i++){
						if(block[i][FL]==0){
							check=i;
							break;
						}
					}
					if(check != -1){
						var rnd=Math.floor(Math.random()*4);
						if(rnd != 0){//item or block
							//ブロックセット
							rnd=Math.floor(Math.random()*3);
							if(rnd!=block[check][PARA]){
								block[check][PARA]=rnd;
								block[check][IMG].src="img/block0_"+block[check][PARA]+".png";
								block[check][IMG].onload = function () {
									block[check][FL] = 1;
									block[check][WIDTH] = block_size[block[check][PARA]][0];
									block[check][HEIGHT]= block_size[block[check][PARA]][1];
									block[check][X] = 800;
									block[check][Y] = 504-block[check][HEIGHT];
								}
							}else{
								block[check][X] = 800;
								block[check][Y] = 504-block[check][HEIGHT];
								block[check][FL] = 1;
							}
						}else{
							//アイテムセット
							if(item[FL]==0){
								item[PARA] = 0;
								item[X] = 800;
								item[Y] = 504-item[HEIGHT];
								item[IMG].src="img/item_hp.png";
								item[IMG].onload = function () {
									item[FL] = 1;
								}
							}
						}
					}
					block_cnt = WAITTIME+Math.floor(Math.random()*180);//次のブロック出現までの時間
				}
				PlayerHit();
				Blink();
				Scroll();
				Draw();
				requestAnimationFrame(UpDate);
			}
			
			function Blink(){
				if(blink_cnt==0)return;
				
				blink_timer++;
				if(blink_timer >= 5){
					blink_fl *= -1;
					blink_cnt -= 1;
					blink_timer = 0;
					if(blink_cnt == 0){
						blink_fl=1;
						if(f.player_hp<0){
							if(hitEnemyNum != -1){
								hitEnemyNum -= -1;
							}
							if(hitBlockNum != -1){
								block[hitBlockNum][FL] = 0;
								hitBlockNum -= -1;
							}
						}
					}
				}
							
			}
			
			function Scroll(){
				if(isPaused)return;
				
				//アイテム---------------
				if(item[FL]==1){
					item[X] -= scroll_sp;
					if(item[X] <= item[WIDTH]*-1){
						item[FL]=0;
					}
				}
				//ブロック---------------
				for(var i=0;i<BLOCK_MAX;i++){
					if(block[i][FL]==1){
						block[i][X] -= scroll_sp;
						if(block[i][X] <= block[i][WIDTH]*-1){
							block[i][FL]=0;
						}
					}
				}
				//地面---------------
				for(var i=0;i<6;i++){
					ground[i][X] -= scroll_sp;
					if(ground[i][X] <= -160){
						var rnd = Math.floor(Math.random()*3);
						if(ground[i][PARA] != rnd){
							ground[i][PARA] = rnd;
							ground[i][IMG].src="img/stage0_"+ground[i][PARA]+".png";
						}
						ground[i][X] = 800 - (Math.abs(ground[i][X]) - 160);
					}
				}
			}
			
			function Draw(){
				ctx.clearRect(0,0,800,600);
				//プレイヤー
				if(player[FL] == 1 && blink_fl == 1)ctx.drawImage(player[IMG], player[X], player[Y]);
				//アイテム
				if(item[FL] == 1)ctx.drawImage(item[IMG], item[X], item[Y]);
				//ブロック
				for(var i=0;i<BLOCK_MAX;i++){
					if(block[i][FL]==1){
						ctx.drawImage(block[i][IMG], block[i][X], block[i][Y]);
					}
				}
				//地面
				for(var i=0;i<6;i++){
					ctx.drawImage(ground[i][IMG], ground[i][X], ground[i][Y]);
				}
			}
			
			function AniSet(){
				switch(ani_type){
				
				}
			}
			
			function EndAnm(){
				if(ani_type == 0)break;
				
				
			}
			
			function PlayerHit(){
				//ブロック
				var abs_x,abs_y;
				var hit_x,hit_y;
				for(var i=0;i<block.length;i++){
					if(block[i][FL]==1){
						abs_x=Math.abs(block[i][X]-player[X]);
						abs_y=Math.abs(block[i][Y]-player[Y]);
						hit_x=(block[i][WIDTH]+player[WIDTH])/2;
						hit_y=(block[i][HEIGHT]+player[HEIGHT])/2;
						if(abs_x<=hit_x && abs_y<=hit_y && blink_cnt==0){
							blink_fl *= -1;
							blink_timer=0;
							blink_cnt=9;
							player[FL]=0;
							hitBlockNum=i;
							f.player_hp -= 1;
							if(f.player_hp<0){
								isPaused=true;
								player[FL]=1;
							}else{
								ImgChange("img/player"+f.player_hp+"_run.png");
							}
						}
					}
				}
				//アイテム
				if(item[FL]==1){
					abs_x=Math.abs(item[X]-player[X]);
					abs_y=Math.abs(item[Y]-player[Y]);
					hit_x=(item[WIDTH]+player[WIDTH])/2;
					hit_y=(item[HEIGHT]+player[HEIGHT])/2;
					if(abs_x<=hit_x && abs_y<=hit_y){
						item[FL]=0;
						if(f.player_hp < 3){
							f.player_hp += 1;
							ImgChange("img/player"+f.player_hp+"_run.png");
						}
					}
				}
			}
			
			function ImgChange(src){
				player[FL]=0;
				player[IMG].src="img/player"+f.player_hp+"_run.png";
				player[IMG].onload = function () {
					player[FL]=1;
				}
			}
			
			
			
			
			
			
			
			
			
		</script>
	</body>
	<!--04/22start-->
</html>